{% set current_page = 'recipes' %}
{% extends 'base.html' %}

{% block title %}{{ recipe.name }} ‚Äî Opskrifter{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">

    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 mb-4">
        <a href="/recipes" class="hover:underline text-green-700">Opskrifter</a>
        <span class="mx-2">/</span>
        <span class="text-gray-700">{{ recipe.name }}</span>
    </nav>

    <div class="flex flex-col lg:flex-row gap-6">

        <!-- ============================
             LEFT COLUMN ‚Äî Recipe content
             ============================ -->
        <div class="flex-1 min-w-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8">

                <!-- Header -->
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-gray-800 leading-tight mb-2">
                            {{ recipe.name }}
                        </h1>

                        <!-- Source badge -->
                        <span class="inline-block text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">
                            {% if recipe.source == 'ai_generated' %}ü§ñ AI-genereret
                            {% elif recipe.source == 'meal_plan' %}üìã Gemt fra madplan
                            {% elif recipe.source == 'web_import' %}üåê Importeret
                            {% else %}‚úèÔ∏è Manuel{% endif %}
                        </span>
                        {% if recipe.source_url %}
                        <a href="{{ recipe.source_url }}" target="_blank" rel="noopener"
                           class="ml-2 text-xs text-blue-500 hover:underline">Se original ‚Üó</a>
                        {% endif %}
                    </div>

                    <!-- Delete button -->
                    <button
                        hx-delete="/recipes/{{ recipe.id }}"
                        hx-confirm="Slet denne opskrift? Det kan ikke fortrydes."
                        hx-on::after-request="window.location='/recipes'"
                        class="text-red-400 hover:text-red-600 text-sm transition"
                        title="Slet opskrift"
                    >üóë</button>
                </div>

                <!-- Meta row: cook time + servings -->
                <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-5">
                    {% if recipe.cook_time_minutes %}
                    <span>‚è± {{ recipe.cook_time_minutes }} min</span>
                    {% endif %}
                    {% if recipe.servings %}
                    <span>üçΩ {{ recipe.servings }} portioner</span>
                    {% endif %}
                </div>

                <!-- Tags -->
                <div id="recipe-tags" class="flex flex-wrap gap-2 mb-5">
                    {% for tag in (recipe.tags or []) %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">
                        {{ tag }}
                        <button
                            hx-post="/recipes/{{ recipe.id }}/tags"
                            hx-vals='{"tag": "{{ tag }}", "action": "remove"}'
                            hx-target="#recipe-tags"
                            hx-swap="outerHTML"
                            class="hover:text-red-600 leading-none"
                        >&times;</button>
                    </span>
                    {% endfor %}
                    <form hx-post="/recipes/{{ recipe.id }}/tags" hx-target="#recipe-tags" hx-swap="outerHTML"
                          hx-on::after-request="this.reset()" class="inline-flex items-center">
                        <input name="tag" placeholder="tilf√∏j tag‚Ä¶"
                               class="border border-gray-300 rounded px-2 py-0.5 text-xs w-24 focus:outline-none focus:ring-1 focus:ring-green-400">
                        <input type="hidden" name="action" value="add">
                        <button class="ml-1 text-xs text-green-700 hover:underline">+</button>
                    </form>
                </div>

                {% if recipe.description %}
                <p class="text-gray-600 italic mb-6">{{ recipe.description }}</p>
                {% endif %}

                <!-- Ingredients -->
                {% set ingredients = recipe.ingredients or [] %}
                {% if ingredients %}
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Ingredienser</h2>
                <ul class="space-y-1 mb-6">
                    {% for ing in ingredients %}
                    <li class="flex items-baseline gap-2 text-sm">
                        <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0 mt-1.5"></span>
                        <span class="text-gray-500 w-20 flex-shrink-0">
                            {{ ing.quantity or '' }}{% if ing.unit %} {{ ing.unit }}{% endif %}
                        </span>
                        <span class="text-gray-800">{{ ing.name }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}

                <!-- Instructions -->
                {% if recipe.instructions %}
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Fremgangsm√•de</h2>
                <div class="prose prose-sm max-w-none text-gray-700 mb-6">
                    {{ recipe.instructions | replace('\n', '<br>') | safe }}
                </div>
                {% endif %}

                <!-- Rating -->
                <div class="border-t border-gray-100 pt-5 mt-5">
                    <h3 class="font-semibold text-gray-700 mb-3">Bed√∏m opskriften</h3>
                    <form
                        hx-post="/recipes/{{ recipe.id }}/rate"
                        hx-target="#rating-result"
                        hx-swap="innerHTML"
                        class="flex items-center gap-4"
                    >
                        <div class="flex gap-1">
                            {% for i in range(1, 6) %}
                            <label class="cursor-pointer text-2xl" title="{{ i }} stjerne{{ 'r' if i > 1 }}">
                                <input type="radio" name="rating" value="{{ i }}"
                                       {% if recipe.rating == i %}checked{% endif %}
                                       class="sr-only">
                                <span class="star-label {% if recipe.rating and recipe.rating >= i %}text-yellow-400{% else %}text-gray-300{% endif %} hover:text-yellow-400 transition">‚òÖ</span>
                            </label>
                            {% endfor %}
                        </div>
                        <button type="submit" class="text-sm text-green-700 hover:underline">Gem bed√∏mmelse</button>
                        <span id="rating-result" class="text-sm"></span>
                    </form>
                </div>

                <!-- Family Notes -->
                <div class="border-t border-gray-100 pt-5 mt-5">
                    <h3 class="font-semibold text-gray-700 mb-2">Familiens noter</h3>
                    <p class="text-xs text-gray-400 mb-2">Tips, minder, variationer ‚Äî gem hvad der virker for jeres familie.</p>
                    <form
                        hx-post="/recipes/{{ recipe.id }}/notes"
                        hx-target="#notes-result"
                        hx-swap="innerHTML"
                    >
                        <textarea
                            name="notes"
                            rows="3"
                            placeholder="fx b√∏rnene elsker ekstra ost, brug fuldkornspasta, god til madlavning p√• forh√•nd‚Ä¶"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-400 resize-none"
                        >{{ recipe.notes or '' }}</textarea>
                        <div class="flex items-center gap-3 mt-2">
                            <button type="submit"
                                    class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm hover:bg-green-700 transition">
                                Gem noter
                            </button>
                            <span id="notes-result" class="text-sm"></span>
                        </div>
                    </form>
                </div>

                <!-- Add to Shopping List -->
                <div class="border-t border-gray-100 pt-5 mt-5">
                    <button
                        hx-post="/recipes/{{ recipe.id }}/add-to-shopping-list"
                        hx-target="#shopping-result"
                        hx-swap="innerHTML"
                        class="bg-orange-500 text-white px-5 py-2 rounded-lg hover:bg-orange-600 transition font-medium text-sm"
                    >
                        üõí Tilf√∏j ingredienser til indk√∏bsliste
                    </button>
                    <span id="shopping-result" class="ml-3 text-sm"></span>
                </div>

            </div>
        </div>

        <!-- ============================
             RIGHT COLUMN ‚Äî AI Sidebar
             ============================ -->
        <div class="lg:w-80 xl:w-96 flex-shrink-0">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 lg:sticky lg:top-24 flex flex-col"
                 style="max-height: calc(100vh - 7rem);">

                <div class="px-4 py-3 border-b border-gray-100 bg-green-50 rounded-t-xl">
                    <h3 class="font-semibold text-green-800 text-sm">ü§ñ Sp√∏rg kokken</h3>
                    <p class="text-xs text-green-600 mt-0.5">Variationer, substitutter, skalering‚Ä¶</p>
                </div>

                <!-- Chat messages area -->
                <div id="recipe-chat-messages"
                     class="flex-1 overflow-y-auto px-3 py-3 space-y-1 min-h-0">
                    <!-- Messages loaded via HTMX -->
                </div>

                <!-- Input area ‚Äî loaded after chat starts -->
                <div id="recipe-chat-input-{{ recipe.id }}" class="px-3 pb-3 pt-2 border-t border-gray-100">
                    <button
                        hx-post="/recipes/{{ recipe.id }}/chat/start"
                        hx-target="#recipe-chat-messages"
                        hx-swap="innerHTML"
                        class="w-full bg-green-600 text-white py-2 rounded-lg text-sm hover:bg-green-700 transition"
                    >
                        Start madlavningschat
                    </button>
                </div>

            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Highlight stars on hover
document.querySelectorAll('.star-label').forEach((star, idx, all) => {
    const radio = star.previousElementSibling;
    star.addEventListener('mouseenter', () => {
        all.forEach((s, i) => {
            s.classList.toggle('text-yellow-400', i <= idx);
            s.classList.toggle('text-gray-300', i > idx);
        });
    });
    star.addEventListener('mouseleave', () => {
        const checked = document.querySelector('input[name="rating"]:checked');
        const checkedIdx = checked ? parseInt(checked.value) - 1 : -1;
        all.forEach((s, i) => {
            s.classList.toggle('text-yellow-400', i <= checkedIdx);
            s.classList.toggle('text-gray-300', i > checkedIdx);
        });
    });
});

// After chat start, swap input area into messages container
document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.target.id === 'recipe-chat-messages') {
        e.target.scrollTop = e.target.scrollHeight;
    }
});
</script>
{% endblock %}
