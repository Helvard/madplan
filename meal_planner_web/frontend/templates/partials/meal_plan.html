<!-- Meal plan display partial - partials/meal_plan.html -->

<div class="flex items-start gap-3">
    <div class="flex-shrink-0 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">
        ü§ñ
    </div>
    <div class="flex-1 bg-green-50 border border-green-200 rounded-lg p-6 max-w-3xl">
        <div class="prose prose-sm max-w-none">
            <!-- Render meal plan as markdown -->
            {{ meal_plan | safe }}
        </div>

        <div class="mt-6 pt-4 border-t border-green-200">
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-3">
                <button
                    onclick="showShoppingListPrompt('{{ session_id }}')"
                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-semibold"
                >
                    ‚úÖ Godkend madplan
                </button>
                <button
                    onclick="document.getElementById('feedback-input-{{ session_id }}').classList.remove('hidden'); this.style.display='none';"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition"
                >
                    üîÑ Foresl√• √¶ndringer
                </button>
                <button
                    onclick="document.getElementById('save-recipe-input-{{ session_id }}').classList.remove('hidden'); this.style.display='none';"
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition"
                >
                    üìñ Gem en opskrift
                </button>
            </div>

            <!-- Save a Recipe from this plan -->
            <div id="save-recipe-input-{{ session_id }}" class="hidden mb-3">
                <form method="post" action="/recipes/save-from-meal-plan" class="flex gap-2 items-center">
                    <input type="hidden" name="meal_plan_text" value="{{ meal_plan_raw | e }}">
                    <input
                        type="text"
                        name="meal_name"
                        placeholder="Hvilken ret? f.eks. Mandag laksepasta"
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm"
                        required
                    >
                    <button
                        type="submit"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm"
                    >Gem opskrift</button>
                </form>
                <p class="text-xs text-gray-400 mt-1">Claude genererer den fulde opskrift ‚Äî ingredienser, fremgangsm√•de og tips.</p>
            </div>

            <!-- Shopping List Prompt (Hidden initially) -->
            <!-- The entire prompt div is swapped out by the "Yes" button response (outerHTML) -->
            <div id="shopping-list-prompt-{{ session_id }}" class="hidden mb-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="font-semibold mb-3">üìù Vil du tilf√∏je ingredienser til indk√∏bslisten?</p>
                <div class="flex flex-wrap gap-3 items-center">
                    <button
                        hx-post="/shopping-list/add-from-meal-plan"
                        hx-vals='{"session_id": "{{ session_id }}"}'
                        hx-target="#shopping-list-prompt-{{ session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition disabled:opacity-50"
                    >
                        Ja, tilf√∏j til indk√∏bslisten
                    </button>
                    <button
                        hx-post="/chat/accept-plan"
                        hx-vals='{"session_id": "{{ session_id }}"}'
                        hx-target="#chat-messages"
                        hx-swap="beforeend"
                        onclick="acceptPlanFinal('{{ session_id }}')"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"
                    >
                        Nej, gem kun madplanen
                    </button>
                    <span class="htmx-indicator text-gray-500 text-sm">‚è≥ Tilf√∏jer varer...</span>
                </div>
            </div>

            <!-- Hidden feedback input -->
            <div id="feedback-input-{{ session_id }}" class="hidden">
                <form
                    hx-post="/chat/refine-plan"
                    hx-target="#chat-messages"
                    hx-swap="beforeend"
                    class="flex gap-2"
                >
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <input
                        type="text"
                        name="feedback"
                        placeholder="Hvad vil du √¶ndre? (f.eks. 'byt dag 3 ud med noget nemmere')"
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2"
                        required
                    >
                    <button
                        type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                    >
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function showShoppingListPrompt(sessionId) {
    // Hide accept button, show shopping list prompt
    event.target.style.display = 'none';
    document.getElementById('shopping-list-prompt-' + sessionId).classList.remove('hidden');
}

function acceptPlanFinal(sessionId) {
    // Hide the prompt after selection
    document.getElementById('shopping-list-prompt-' + sessionId).classList.add('hidden');
}
</script>
